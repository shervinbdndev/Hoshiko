@inject Hoshiko.Core.Interfaces.ICurrentUserService CurrentUser
<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - هوشیکو</title>

    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;900&display=swap" rel="stylesheet">
</head>

<body class="koto-body">

    <div class="koto-topbar">

        <div class="koto-cert-search">
            <i data-lucide="search"></i>
            <input
                type="text"
                id="certificateSearchInput"
                placeholder="شناسه مدرک را وارد کنید..."
            />
        </div>

        @if (User.Identity?.IsAuthenticated ?? false)
        {
            <div class="koto-user-menu">
                <div class="user-icon">
                    <i data-lucide="user"></i>
                </div>

                <div class="user-tooltip">
                    <div class="username">@User.Identity!.Name</div>

                    <div class="user-role @(CurrentUser.IsAdmin ? "admin" : "user")">
                        @(CurrentUser.IsAdmin ? "مدیر سیستم" : "کاربر")
                    </div>

                    @if (CurrentUser.IsAdmin) {
                        <a asp-controller="Admin"
                            asp-action="Index"
                            class="admin-panel-link">پنل مدیریت</a>
                    }

                    <form asp-controller="Account" asp-action="Logout" method="post">
                        <button type="submit" class="logout-btn">خروج</button>
                    </form>
                </div>
            </div>
        }

    </div>

    <div class="koto-container">
        @RenderBody()
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        lucide.createIcons();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document
            .getElementById("certificateSearchInput")
            ?.addEventListener("keydown", async function (e) {

                if (e.key !== "Enter") return;

                const code = this.value.trim();
                if (!code) return;

                Swal.fire({
                    title: "در حال بررسی مدرک...",
                    background: "#020617",
                    color: "#eafff2",
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                try {
                    const res = await fetch(`/Home/Search?code=${encodeURIComponent(code)}`);

                    if (!res.ok) throw new Error();

                    const html = await res.text();

                    Swal.fire({
                        width: "900px",
                        background: "#020617",
                        color: "#eafff2",
                        showCloseButton: true,
                        showConfirmButton: false,
                        html
                    });

                } catch {
                    Swal.fire({
                        icon: "error",
                        title: "مدرک یافت نشد",
                        text: "شناسه مدرک معتبر نیست یا لغو شده است",
                        background: "#020617",
                        color: "#eafff2",
                        confirmButtonColor: "#22c55e"
                    });
                }
            });
        </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
